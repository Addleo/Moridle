<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moridle</title>
  <link rel="icon" href="./icon.png" type="image/png">
  <style>
    :root{
      --bg:#0f1220; --panel:#161A2A; --text:#E7EAF6; --muted:#9aa2c3;
      --ok:#2ECC71; --mid:#F1C40F; --bad:#3C455C; --accent:#7B6CFF;
      --border:#2a3050; --danger:#FF6B6B;
    }
    html,body{height:100%}
    body{margin:0;background: url('./background.png') no-repeat center center fixed;background-size: cover;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    h1{font-size:clamp(22px,3vw,32px);margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;align-items:center}
    input,button{background:#0b0e1a;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:14px}
    input:focus{outline:2px solid var(--accent)}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:0}
    button.ghost{background:transparent}
    .grid{overflow:auto;border-radius:14px;border:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;}
    th{position:sticky;top:0;background:#12162a;z-index:1}

    .stat{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;font-weight:600;}
    .stat-traits { display: flex; flex-wrap: wrap; gap: 8px; }
    .ok{background:color-mix(in hsl, var(--ok) 25%, transparent);outline:1px solid color-mix(in hsl, var(--ok) 55%, #000);} 
    .bad{background:color-mix(in hsl, var(--danger) 25%, transparent);outline:1px solid color-mix(in hsl, var(--danger) 55%, #000);} 
    .namecell{display:flex;align-items:center;gap:10px}
    .realmcell {display: flex;align-items: center;gap: 6px;justify-content: space-between;}
    .realmcell img {width: 40px;height: 40px;object-fit: contain;}
    .avatar{width:48px;height:48px;border-radius:8px;background:#0b0e1a;border:1px solid var(--border);object-fit:cover}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .hint{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center;position: sticky;top: 0;background: var(--panel);padding: 8px;z-index: 3;}
    .grow{flex:1}
    .right{margin-left:auto}
    .footer{opacity:.75;margin-top:16px;font-size:12px}
    .kbd{border:1px solid var(--border);border-bottom-color:#000;background:#0b0e1a;padding:2px 6px;border-radius:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .share{white-space:pre-wrap;background:#0b0e1a;border-radius:12px;padding:10px;border:1px dashed var(--border)}
    .plug {position: fixed;bottom: 0;text-align: center;padding: 8px 0;font-size: 13px;opacity: 0.6;width: 100%;}
    .plug a {color: var(--text);text-decoration: none;}
    .plug a:hover {text-decoration: underline;opacity: 0.8;}
    @media (max-width: 600px) {
      .wrap { padding: 12px; }
      input, button { padding: 10px 6px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Moridle</h1>
  <div class="sub">Guess the hidden character. Each player gets a new one every day!</div>

  <div class="panel" id="play">
    <div class="flex">
      <div class="grow row">
        <input id="guessInput" list="names" placeholder="Type a character nameâ€¦" autocomplete="off" />
        <datalist id="names"></datalist>
        <button id="btnGuess" class="primary">Guess</button>
        <button id="btnGiveUp" class="ghost">Give up</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <table id="results">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="end" style="display:none;margin-top:12px">
      <div id="endMsg" style="font-weight:700;margin-bottom:6px"></div>
      <div class="share" id="shareBox"></div>
      <div class="footer">Refresh for a new character tomorrow.</div>
    </div>
  </div>

</div>

<div class="plug">
  <a href="https://twitch.tv/addleo" target="_blank">Consider checking me out : twitch.tv/addleo</a>
</div>

<script>
// ============================
// 1) PASTE YOUR DATASET HERE
// ============================
let characters = [
    { //Ramona
        "name": "Ramona",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Keyflare generation","Drawing"],
        "rarity": "SR"
    },
    { //Ogier
        "name": "Ogier",
        "realm": "Chaos",
        "class": "Warden",
        "gender": "Male",
        "traits": ["Shield","Str stacking"],
        "rarity": "SR"
    },
    { //Doll
        "name": "Doll",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Healing","Aliemus battery"],
        "rarity": "SR"
    },
    { //Lotan
        "name": "Lotan",
        "realm": "Chaos",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Strike","AoE"],
        "rarity": "SR"
    },
    { //Nautila
        "name": "Nautila",
        "realm": "Chaos",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Aliemus battery", "Counter","Shield"],
        "rarity": "SSR"
    },
    { //Karen
        "name": "Karen",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Arithmetica", "Poison","Healing","Weakness"],
        "rarity": "SSR"
    },
    { //Nymphaea
        "name": "Nymphaea",
        "realm": "Chaos",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Poison"],
        "rarity": "SSR"
    },
    { //Pandia
        "name": "Pandia",
        "realm": "Chaos",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Counter","AoE"],
        "rarity": "SSR"
    },
    { //Alva
        "name": "Alva",
        "realm": "Chaos",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Shield","Shield-scaling damage"],
        "rarity": "SSR"
    },
    { //24
        "name": "24",
        "realm": "Chaos",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Weakness","Vulnerable","Single-target damage","Multi-hit"],
        "rarity": "SSR"
    },
    { //G-Doll
        "name": "G-Doll",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Poison","Healing","Aliemus battery","Dmg amp"],
        "rarity": "SSR"
    },
    { //Lily
        "name": "Lily",
        "realm": "Chaos",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Shield","Poison","Healing"],
        "rarity": "SSR"
    },
    { //Tawil
        "name": "Tawil",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Drawing","Keyflare generation","multi-hit","str stacking","Card generation"],
        "rarity": "SSR"
    },
    { //Ryker
        "name": "Ryker",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Male",
        "traits": ["Str stacking","Drawing"],
        "rarity": "SSR"
    },
    { //Hameln
        "name": "Hameln",
        "realm": "Chaos",
        "class": "Chorus",
        "gender": "Male",
        "traits": ["Str stacking","Drawing","Insight"],
        "rarity": "SSR"
    },
    { //Kathigu-Ra
        "name": "Kathigu-Ra",
        "realm": "Chaos",
        "class": "Assault",
        "gender": "Female",
        "traits": ["str stacking","AoE"],
        "rarity": "SSR"
    },
    { //Caecus
        "name": "Caecus",
        "realm": "Aequor",
        "class": "Warden",
        "gender": "Male",
        "traits": ["Counter","Healing","Shield","Counter-scaling damage"],
        "rarity": "SSR"
    },
    { //Goliath
        "name": "Goliath",
        "realm": "Aequor",
        "class": "Assault",
        "gender": "Male",
        "traits": ["Str stacking","Str stealing"],
        "rarity": "SSR"
    },
    { //Celeste
        "name": "Celeste",
        "realm": "Aequor",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Healing","Ressurection","Arithmetica"],
        "rarity": "SSR"
    },
    { //Faros
        "name": "Faros",
        "realm": "Aequor",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Poison","Drawing"],
        "rarity": "SSR"
    },
    { //Sanga
        "name": "Sanga",
        "realm": "Aequor",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Shield","Shield-scaling damage","AoE"],
        "rarity": "SSR"
    },
    { //Aurita
        "name": "Aurita",
        "realm": "Aequor",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Discard","Drawing","Aftershock"],
        "rarity": "SSR"
    },
    { //Tulu
        "name": "Tulu",
        "realm": "Aequor",
        "class": "Assault",
        "gender": "Male",
        "traits": ["Aftershock","Str stacking","Tentacle dmg","Weakness"],
        "rarity": "SSR"
    },
    { //Murphy
        "name": "Murphy",
        "realm": "Aequor",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Sacrifice","Arithmetica","Shield","Weakness","Vulnerable","Keyflare generation","Tentacle dmg","Dmg reduction"],
        "rarity": "SSR"
    },
    { //Corposant
        "name": "Corposant",
        "realm": "Aequor",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Str stacking","Shield","Aftershock","Weakness","Discard","Multi-hit","Drawing"],
        "rarity": "SSR"
    },
    { //Myriam
        "name": "Myriam",
        "realm": "Aequor",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Poison","Tentacle dmg","Aliemus battery","Drawing","Str stacking"],
        "rarity": "SSR"
    },
    { //Agrippa
        "name": "Agrippa",
        "realm": "Caro",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Poison","Shield","Str stacking","Alert stacking","Embryo fusion"],
        "rarity": "SSR"
    },
    { //Faint
        "name": "Faint",
        "realm": "Caro",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Counter","Shield","Healing"],
        "rarity": "SSR"
    },
    { //Leigh
        "name": "Leigh",
        "realm": "Caro",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Str stacking","Shield on damage taken","Healing","Embryo fusion"],
        "rarity": "SSR"
    },
    { //Aigis
        "name": "Aigis",
        "realm": "Caro",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Vulnerable","Embryo fusion","Petrify"],
        "rarity": "SSR"
    },
    { //Helot
        "name": "Helot",
        "realm": "Caro",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Strike"],
        "rarity": "SSR"
    },
    { //Uvhash
        "name": "Uvhash",
        "realm": "Caro",
        "class": "Assault",
        "gender": "Male",
        "traits": ["Str stacking","AoE"],
        "rarity": "SSR"
    },
    { //Sorel
        "name": "Sorel",
        "realm": "Caro",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Str stacking","Multi-hit","Healing"],
        "rarity": "SSR"
    },
    { //G-Helot
        "name": "G-Helot",
        "realm": "Caro",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Bleeding","Str stacking","Drawing","Echo"],
        "rarity": "SSR"
    },
    { //Salvador
        "name": "Salvador",
        "realm": "Caro",
        "class": "Warden",
        "gender": "Male",
        "traits": ["Str stacking","Weakness","Embryo fusion","Vulnerable","Barrier","Furnace"],
        "rarity": "SSR"
    },
    { //Thais
        "name": "Thais",
        "realm": "Caro",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Str stacking","Embryo fusion","Aliemus battery","Bleeding","Counter","Poison"],
        "rarity": "SSR"
    },
    { //Doresain
        "name": "Doresain",
        "realm": "Caro",
        "class": "Assault",
        "gender": "Male",
        "traits": ["Str stacking","AoE"],
        "rarity": "SSR"
    },
    { //Pickman
        "name": "Pickman",
        "realm": "Caro",
        "class": "Chorus",
        "gender": "Male",
        "traits": ["Embryo fusion","Card generation","Str stealing","Str stacking","Dmg amp"],
        "rarity": "SSR"
    },
    { //Casiah
        "name": "Casiah",
        "realm": "Ultra",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Drawing"],
        "rarity": "SSR"
    },
    { //Jenkin
        "name": "Jenkin",
        "realm": "Ultra",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Multi-hit"],
        "rarity": "SSR"
    },
    { //Liz
        "name": "Liz",
        "realm": "Ultra",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Poison"],
        "rarity": "SSR"
    },
    { //Winkle
        "name": "Winkle",
        "realm": "Ultra",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Aliemus battery","Counter"],
        "rarity": "SSR"
    },
    { //Tinct
        "name": "Tinct",
        "realm": "Ultra",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Strike"],
        "rarity": "SSR"
    },
    { //Erica
        "name": "Erica",
        "realm": "Ultra",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Str stacking","Alert stacking"],
        "rarity": "SSR"
    },
    { //Clementine
        "name": "Clementine",
        "realm": "Ultra",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Str stacking","Keyflare generation","Healing","Dmg amp","Quasar","Dmg reduction"],
        "rarity": "SSR"
    },
    { //Daffodil
        "name": "Daffodil",
        "realm": "Ultra",
        "class": "Assault",
        "gender": "Female",
        "traits": ["Str stacking","Vulnerable","Poison","Counter"],
        "rarity": "SSR"
    },
    { //Castor
        "name": "Castor",
        "realm": "Ultra",
        "class": "Warden",
        "gender": "Male",
        "traits": ["Shield","Drawing","Weakness","Dmg amp"],
        "rarity": "SSR"
    },
    { //Wanda
        "name": "Wanda",
        "realm": "Ultra",
        "class": "Warden",
        "gender": "Female",
        "traits": ["Counter","Dmg reduction"],
        "rarity": "SSR"
    },
    { //Horla
        "name": "Horla",
        "realm": "Ultra",
        "class": "Chorus",
        "gender": "Female",
        "traits": ["Healing","Dmg amp","aliemus battery","str stacking"],
        "rarity": "SSR"
    },
];

// attach local icons
characters = characters.map(c => ({ ...c, image: `./Character_icons/${c.name}.png` }));

// ============================
// 2) GAME LOGIC + PERSISTENCE
// ============================
const $ = (sel, el=document) => el.querySelector(sel);
const byName = (a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'});

// --- deterministic helpers
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;var t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return ((t^t>>>14)>>>0)/4294967296}}
function strSeed(s){let h=2166136261; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=(h*16777619)>>>0} return h>>>0}
function pickIndex(len, seed){const r=mulberry32(strSeed(seed))(); return Math.floor(r*len)}
function todayUTC(){const d=new Date(); return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()))}
function ymd(d){return d.toISOString().slice(0,10)}
function datasetSignature(list){const names=list.map(x=>x.name).sort().join('|'); return strSeed(names).toString(36)}

// --- table helpers
function inferColumns(list){
  const keys = new Set();
  list.forEach(o=>Object.keys(o).forEach(k=>{if(k!=='name'&&k!=='image') keys.add(k)}));
  return [...keys];
}
function normalize(v){
  if(v==null) return '';
  if(Array.isArray(v)) return v.map(x=>normalize(x)).filter(Boolean);
  if(typeof v==='number') return v;
  return String(v).trim();
}
function compareCell(guessVal, answerVal){
  const g = normalize(guessVal), a = normalize(answerVal);
  if(Array.isArray(g)||Array.isArray(a)){
    const setG = new Set(Array.isArray(g)?g:[g]);
    const setA = new Set(Array.isArray(a)?a:[a]);
    const inter=[...setG].filter(x=>setA.has(x));
    if(inter.length){
      const exact = setG.size===setA.size && inter.length===setG.size;
      return {type: exact? 'ok':'mid', text: Array.isArray(guessVal)?guessVal.join(', '):guessVal}
    }
    return {type:'bad', text: Array.isArray(guessVal)?guessVal.join(', '):guessVal}
  }
  if(typeof g==='number'&&typeof a==='number'){
    if(g===a) return {type:'ok', text:g}
    return {type:'mid', text: g + (g<a?' â†‘':' â†“')}
  }
  const gs=String(g).toLowerCase(), as=String(a).toLowerCase();
  if(gs===as) return {type:'ok', text:guessVal}
  if(gs && as && (gs.includes(as)||as.includes(gs))) return {type:'mid', text:guessVal}
  return {type:'bad', text:guessVal}
}

// --- global state
let STATE = {
  list: [], cols: [], answer: null, attempts: [], finished: false, win: false,
  // derived keys
  day: '', sig: '', seed: '', storageKey: '', seedKeyNew: '', seedKeyLegacy: ''
};

// --- storage helpers
function makeKeys(){
  const day = ymd(todayUTC());
  const sig = datasetSignature(characters);
  const seedKeyNew = `moridle:seed:${sig}:${day}`;
  const seedKeyLegacy = `moridle-seed-${day}`; // read for backward compat
  const stateKey = `moridle:state:${sig}:${day}`;
  return { day, sig, seedKeyNew, seedKeyLegacy, stateKey };
}

function loadSeed(keys){
  let seed = localStorage.getItem(keys.seedKeyNew) || localStorage.getItem(keys.seedKeyLegacy);
  if(!seed){
    seed = Math.random().toString(36).slice(2);
    localStorage.setItem(keys.seedKeyNew, seed);
    // also set legacy for continuity (harmless)
    localStorage.setItem(keys.seedKeyLegacy, seed);
  }
  return seed;
}

function loadPersisted(keys){
  try { return JSON.parse(localStorage.getItem(keys.stateKey) || 'null'); }
  catch { return null; }
}

function savePersisted(keys, data){
  localStorage.setItem(keys.stateKey, JSON.stringify(data));
}

// --- UI build
// no need to pre-fill the datalist anymore
// make setupNamesDatalist a no-op (we'll populate dynamically)
function setupNamesDatalist(){
  $('#names').innerHTML = '';
}

// Populate datalist only when user types (and exclude already guessed names)
function updateDatalistForQuery(query) {
  const dl = $('#names');
  dl.innerHTML = '';
  const q = String(query || $('#guessInput').value || '').trim().toLowerCase();
  if (!q) return; // don't show anything for empty input

  STATE.list
    .filter(c =>
      c.name.toLowerCase().startsWith(q) &&
      !STATE.attempts.some(a => a.name.toLowerCase() === c.name.toLowerCase())
    )
    .sort(byName)
    .forEach(c => {
      const o = document.createElement('option');
      o.value = c.name;
      dl.appendChild(o);
    });
}

// update as the user types
$('#guessInput').addEventListener('input', (e) => updateDatalistForQuery(e.target.value));

// clear datalist when focusing if input is empty (prevents showing old options)
$('#guessInput').addEventListener('focus', (e) => {
  if (!e.target.value || !e.target.value.trim()) {
    $('#names').innerHTML = '';
  } else {
    updateDatalistForQuery(e.target.value);
  }
});

function headerRow(){
  const thead=$('#results thead'); thead.innerHTML='';
  const tr=document.createElement('tr');
  const thName=document.createElement('th'); thName.textContent='Name'; tr.appendChild(thName);
  STATE.cols.forEach(k=>{const th=document.createElement('th'); th.textContent=k; tr.appendChild(th)});
  thead.appendChild(tr);
}
function rowFor(guess){
  const tr=document.createElement('tr');

  // --- name cell
  const tdName=document.createElement('td');
  const nameWrap=document.createElement('div'); nameWrap.className='namecell';
  const img=document.createElement('img'); img.className='avatar'; img.src=guess.image||''; img.alt='';
  img.style.display=guess.image?'block':'none';
  const nm=document.createElement('div'); nm.textContent=guess.name;
  nameWrap.appendChild(img); nameWrap.appendChild(nm);
  tdName.appendChild(nameWrap);
  tr.appendChild(tdName);

  // --- other cols
  STATE.cols.forEach(k=>{
    const td=document.createElement('td');

    if(k === "traits"){
      // render each trait separately
      const wrap=document.createElement('div');
      wrap.className="stat-traits";
      const guessTraits = Array.isArray(guess[k]) ? guess[k] : [guess[k]];
      const answerTraits = new Set(Array.isArray(STATE.answer[k]) ? STATE.answer[k] : [STATE.answer[k]]);
      guessTraits.forEach(t=>{
        const span=document.createElement('span');
        span.className="stat " + (answerTraits.has(t) ? "ok" : "bad");
        span.textContent=t;
        wrap.appendChild(span);
      });
      td.appendChild(wrap);

    } else if(k === "gender"){
      // strict only ok/bad
      const span=document.createElement('span');
      const correct = String(guess[k]).toLowerCase() === String(STATE.answer[k]).toLowerCase();
      span.className="stat " + (correct ? "ok" : "bad");
      span.textContent=guess[k];
      td.appendChild(span);

    } else if(k === "realm"){
      const res = compareCell(guess[k], STATE.answer[k]);

      const wrap = document.createElement('div');
      wrap.className = 'realmcell';

      // colored realm name
      const span = document.createElement('span');
      span.className = `stat ${res.type}`;
      span.textContent = guess[k];

      // realm icon
      const img = document.createElement('img');
      img.src = `./Realm_icons/${guess[k]}.png`;
      img.alt = guess[k];

      wrap.appendChild(span);
      wrap.appendChild(img);
      td.appendChild(wrap);
    }
    else if (k === "rarity") {
      const span = document.createElement('span');
      const correct = String(guess[k]).toLowerCase() === String(STATE.answer[k]).toLowerCase();
      span.className = "stat " + (correct ? "ok" : "bad");
      span.textContent = guess[k];
      td.appendChild(span);
    }
    else {
      // default behavior for realm, class, rarity
      const res=compareCell(guess[k], STATE.answer[k]);
      const span=document.createElement('span');
      span.className=`stat ${res.type}`;
      span.textContent=res.text??'â€”';
      td.appendChild(span);
    }

    tr.appendChild(td);
  });

  return tr;
}
function renderTable(){
  const tb=$('#results tbody'); tb.innerHTML='';
  STATE.attempts.forEach(g=> tb.appendChild(rowFor(g)));
}
function setInputsDisabled(flag){
  $('#guessInput').disabled = flag;
  $('#btnGuess').disabled = flag;
}

// --- end screen
function showEnd(win){
  STATE.finished = true;
  STATE.win = !!win;
  setInputsDisabled(true);
  $('#end').style.display='block';
  $('#endMsg').textContent = win
    ? `You got it in ${STATE.attempts.length} guesses!`
    : `It was ${STATE.answer.name}.`;

  const squares = STATE.attempts.map(g=>{
  return STATE.cols.map(k=>{
    // Special cases (all-or-nothing)
    if (k === "gender" || k === "rarity") {
      return (String(g[k]).toLowerCase() === String(STATE.answer[k]).toLowerCase())
        ? 'ðŸŸ©'
        : 'ðŸŸ¥';
    }

    // Default behavior
    const c = compareCell(g[k], STATE.answer[k]).type;
    return c === 'ok' ? 'ðŸŸ©' : c === 'mid' ? 'ðŸŸ¨' : 'ðŸŸ¥';
  }).join('');
}).join('\n');

  $('#shareBox').textContent = `Moridle â€” ${win?STATE.attempts.length:'X'} tries\n${squares}`;
}

function persistNow(){
  const keys = {
    stateKey: STATE.storageKey
  };
  const data = {
    attempts: STATE.attempts.map(a => a.name),
    finished: STATE.finished,
    win: STATE.win
  };
  savePersisted(keys, data);
}

// --- gameplay
function guessByName(name){
  return STATE.list.find(x=>x.name.toLowerCase()===name.toLowerCase());
}
function handleGuess(){
  if(STATE.finished) return; // block after solved/given up
  const name=$('#guessInput').value.trim();
  const g=guessByName(name);
  if(!g){ $('#guessInput').focus(); return; }
  if(STATE.attempts.some(a=>a.name.toLowerCase()===g.name.toLowerCase())){
    $('#guessInput').value=''; $('#guessInput').focus(); return;
  }
  STATE.attempts.push(g);
  $('#guessInput').value='';
  $('#names').innerHTML = ''; // <-- clear suggestions immediately
  renderTable();
  // persist after each guess
  persistNow();

  if(g.name===STATE.answer.name){
    showEnd(true);
    persistNow(); // save finished state
  }
}

function giveUp(){
  if(STATE.finished) return;
  // reveal row with the answer like your earlier version
  STATE.attempts.push(STATE.answer);
  $('#names').innerHTML = ''; // <-- clear suggestions
  renderTable();
  showEnd(false);
  persistNow();
}

// --- init / restore
function startGame(){
  STATE.list = characters;
  STATE.cols = inferColumns(characters);

  const keys = makeKeys();
  STATE.day = keys.day;
  STATE.sig = keys.sig;
  STATE.seed = loadSeed(keys);
  STATE.storageKey = keys.stateKey;

  STATE.answer = characters[pickIndex(characters.length, STATE.seed)];

  // restore progress if present
  const saved = loadPersisted(keys);
  STATE.attempts = [];
  STATE.finished = false;
  STATE.win = false;

  if(saved){
    // map saved names back to objects, filter unknowns safely
    const nameToObj = new Map(STATE.list.map(o=>[o.name.toLowerCase(), o]));
    STATE.attempts = (saved.attempts||[])
      .map(n => nameToObj.get(String(n).toLowerCase()))
      .filter(Boolean);
    STATE.finished = !!saved.finished;
    STATE.win = !!saved.win;
  }

  setupNamesDatalist();
  headerRow();
  renderTable();

  if(STATE.finished){
    // lock UI and show end screen exactly as before
    showEnd(STATE.win);
  } else {
    setInputsDisabled(false);
    $('#end').style.display='none';
  }
}

// --- wire events
$('#btnGuess').onclick=handleGuess;
$('#guessInput').addEventListener('keydown',e=>{if(e.key==='Enter') handleGuess()});
$('#btnGiveUp').onclick=giveUp;
document.addEventListener('keydown',e=>{
  if(e.key==='/'){e.preventDefault();$('#guessInput').focus();}
  if(e.key==='Escape'){$('#guessInput').value='';}
});

// go!
startGame();
</script>
</body>
</html>


